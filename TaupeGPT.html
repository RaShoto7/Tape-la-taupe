<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tape-la-taupe ‚Äî Edition Deluxe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      --aurora-1:#0b0f19; --aurora-2:#0f1930; --aurora-3:#172036;
      --glow-a:#8ef3ff; --glow-b:#ffb6ff; --gold:#ffd76d; --bad:#ff6b6b;
      --panel: rgba(255,255,255,.10);
      --shadow: 0 30px 60px rgba(0,0,0,.55);
    }

    /* ====== RESET + BASE ====== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Press Start 2P',cursive;
      color:#e8eef7; overflow:hidden; touch-action:manipulation;
      background: radial-gradient(1200px 800px at 70% -10%, var(--aurora-3) 0%, var(--aurora-2) 60%, var(--aurora-1) 100%);
    }
    .no-select{user-select:none}

    /* Aurora anim√© (fond) */
    body::before, body::after{
      content:""; position:fixed; inset:-20% -20% -20% -20%; z-index:-2;
      background: conic-gradient(from 180deg at 50% 50%, rgba(142,243,255,.16), rgba(255,182,255,.14), rgba(255,215,109,.10), rgba(142,243,255,.16));
      filter: blur(60px);
      animation: aurora 24s linear infinite;
      opacity:.7;
    }
    body::after{ animation-duration: 36s; mix-blend-mode: screen; opacity:.5;}
    @keyframes aurora { to { transform: rotate(1turn); } }

    /* Petits bokeh lents */
    .bokeh{
      position:fixed; inset:0; pointer-events:none; z-index:-1;
      background:
        radial-gradient(60px 60px at 10% 30%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(80px 80px at 80% 20%, rgba(142,243,255,.07), transparent 60%),
        radial-gradient(70px 70px at 30% 80%, rgba(255,182,255,.06), transparent 60%);
      animation: drift 30s ease-in-out infinite alternate;
    }
    @keyframes drift{ from{transform:translateY(-2%)} to{transform:translateY(2%)} }

    /* ====== HUD ====== */
    .hud{
      position:fixed; right:16px; top:16px; z-index:50;
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow); border:1px solid rgba(255,255,255,.12);
    }
    .hud .btn{
      min-width:44px; border:none; padding:10px 12px; border-radius:12px; cursor:pointer;
      background: rgba(255,255,255,.16); color:#e8eef7; font-weight:600;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.2), 0 6px 18px rgba(0,0,0,.25);
      transition: transform .08s ease, box-shadow .2s ease;
    }
    .hud .btn:active{ transform:translateY(1px) scale(.99) }
    .slider{ width:140px; accent-color: var(--glow-a); }

    /* ====== SCREENS ====== */
    .screen{display:none; width:100%; height:100%; flex-direction:column; align-items:center; justify-content:center; position:relative;}
    .screen.active{display:flex}

    /* Accueil : titre glow + boutons en entr√©e */
    .title{
      font-size: clamp(2.2rem, 4vw, 4rem);
      text-shadow: 0 0 24px rgba(142,243,255,.5), 0 0 40px rgba(255,182,255,.35);
      animation: titlePulse 3.5s ease-in-out infinite;
    }
    @keyframes titlePulse{
      0%,100%{ filter: drop-shadow(0 0 0 rgba(0,0,0,0)); }
      50%{ filter: drop-shadow(0 0 18px rgba(142,243,255,.6)); }
    }
    .cta{ opacity:0; transform: translateY(16px) scale(.98); animation: ctaIn .6s ease forwards; }
    .cta:nth-child(1){ animation-delay: .1s}
    .cta:nth-child(2){ animation-delay: .22s}
    .cta:nth-child(3){ animation-delay: .34s}
    .cta:nth-child(4){ animation-delay: .46s}
    @keyframes ctaIn{ to{opacity:1; transform:none} }

    .btn{
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
      color:#e8eef7; border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,.35);
      transition: transform .12s ease, box-shadow .25s ease, filter .2s ease;
      border-radius:14px;
    }
    .btn:hover{ transform: translateY(-2px); filter: saturate(1.05) brightness(1.03); }

    /* Petites cr√©atures d√©coratives √† l'accueil */
    .floaters{ position:absolute; bottom:8%; display:flex; gap:26px; opacity:.9; }
    .floater{ width:56px; height:56px; filter: drop-shadow(0 14px 18px rgba(0,0,0,.35)); animation: updown 2.2s ease-in-out infinite; }
    .floater:nth-child(2){ animation-duration:2.6s; }
    .floater:nth-child(3){ animation-duration:2.9s; }
    @keyframes updown{ 50%{ transform: translateY(-8px) } }

    /* ====== BOARD DELUXE ====== */
    .game-board{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:14px;
      width: min(90vw, 440px); height: min(90vw, 440px); margin: 5px auto;
      padding:18px; border-radius:28px; position:relative; overflow:hidden; /* <-- fix clip */
      background:
        radial-gradient(300px 220px at 50% 20%, rgba(142,243,255,.14), transparent 60%),
        radial-gradient(300px 220px at 50% 80%, rgba(255,182,255,.12), transparent 60%),
        linear-gradient(180deg, #0f1930, #0a1224);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,.06), inset 0 -10px 30px rgba(0,0,0,.35);
      transform: perspective(1000px) rotateX(6deg);
      will-change: transform;
    }
    /* Parallax au survol */
    .game-board[data-tilt="1"]{ transition: transform .2s ease; }
    .game-board[data-tilt="1"].tilting{ transition: none; }

    .hole{
      background: radial-gradient(circle at 50% 35%, #26314f 0%, #131a2d 40%, #0a1020 65%, #000 100%);
      border-radius:50%; position:relative; cursor:pointer; overflow:hidden;
      box-shadow: inset 0 -6px 16px rgba(0,0,0,.6), 0 10px 26px rgba(0,0,0,.5);
      border: 1px solid rgba(255,255,255,.08);
    }
    .hole::after{
      content:""; position:absolute; inset:-6px; border-radius:inherit;
      box-shadow: 0 0 24px 6px rgba(92,225,230,.25), inset 0 0 18px rgba(92,225,230,.25);
      opacity:.8; pointer-events:none;
    }

    /* FIX POP (translateY) ‚Äî plus de bug de la derni√®re ligne */
    .creature{
      position:absolute; left:50%; bottom:0; width:70%; height:70%;
      transform: translate(-50%, 100%); transition: transform .18s cubic-bezier(.2,.9,.15,1.2);
      will-change: transform, filter; transform-origin:50% 100%;
      filter: drop-shadow(0 18px 18px rgba(0,0,0,.45));
      pointer-events:none;
    }
    .hole.up .creature{ transform: translate(-50%, 5%); }
    .creature.gold{ filter: drop-shadow(0 18px 18px rgba(255,215,109,.35)) saturate(1.1); }
    .creature.fox{ filter: drop-shadow(0 18px 18px rgba(255,107,107,.35)); }

    /* Feedback hit */
    .hit-good{ animation: hitGood .22s ease; }
    @keyframes hitGood{ 0%{ filter:brightness(1)} 40%{filter:brightness(1.4) saturate(1.15)} 100%{filter:brightness(1)} }
    .hit-bad{ animation: hitBad .28s ease; }
    @keyframes hitBad{ 0%{ transform:translateY(0)} 30%{transform:translateY(-6px)} 60%{transform:translateY(2px)} 100%{transform:translateY(0)} }

    /* Pop score / p√©nalit√© */
    .point-popup{ position:absolute; font-size:1.2rem; font-weight:bold; pointer-events:none; animation: float-up 1s ease-out forwards; }
    @keyframes float-up{ from{transform:translateY(0);opacity:1} to{transform:translateY(-50px);opacity:0} }
    .time-penalty-display{ position:absolute; color:#ef4444; font-size:1.2rem; animation: fade-out 1s ease-out forwards; }
    @keyframes fade-out{ from{opacity:1} to{opacity:0} }

    /* Nuages accueil (conserv√©s mais plus doux) */
    .cloud{ position:absolute; opacity:0.18; animation: float linear infinite; }
    .cloud svg{ fill:#e8eef7; }
    .cloud1{ top:15%; width:150px; animation-duration:40s; }
    .cloud2{ top:30%; width:100px; animation-duration:60s; animation-delay:-10s; }
    .cloud3{ top:50%; width:200px; animation-duration:50s; animation-delay:-25s; }
    @keyframes float{ from{ transform: translateX(-150px);} to{ transform: translateX(100vw);} }

    /* Utilitaires */
    .scrollable{ overflow-y:auto; max-height:70vh; }
  </style>
</head>

<body class="no-select">
  <div class="bokeh"></div>

  <!-- Canvas d'effets -->
  <canvas id="fx-canvas" class="fx-canvas" style="position:fixed; inset:0; pointer-events:none; z-index:30;"></canvas>

  <!-- HUD -->
  <div class="hud">
    <button id="btnMute" class="btn" aria-pressed="false" title="Activer/D√©sactiver la musique">üîà</button>
    <input id="volMusic" type="range" min="0" max="1" step="0.01" value="0.35" class="slider" title="Volume musique"/>
  </div>

  <div id="main-container" class="h-screen w-screen">

    <!-- ===== Accueil ===== -->
    <div id="homeScreen" class="screen active p-4 text-center">
      <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
        <div class="cloud cloud1"><svg viewBox="0 0 100 60"><path d="M10 60 Q-10 40 15 30 Q5 10 35 20 Q50 0 65 20 Q85 15 85 35 Q115 40 90 55 Z"/></svg></div>
        <div class="cloud cloud2"><svg viewBox="0 0 100 60"><path d="M10 60 Q-10 40 15 30 Q5 10 35 20 Q50 0 65 20 Q85 15 85 35 Q115 40 90 55 Z"/></svg></div>
        <div class="cloud cloud3"><svg viewBox="0 0 100 60"><path d="M10 60 Q-10 40 15 30 Q5 10 35 20 Q50 0 65 20 Q85 15 85 35 Q115 40 90 55 Z"/></svg></div>
      </div>

      <div class="relative z-10 flex flex-col items-center">
        <h1 class="title mb-8">Tape-la-taupe !</h1>

        <!-- d√©cor mignon -->
        <div class="floaters">
          <div id="floater1" class="floater"></div>
          <div id="floater2" class="floater"></div>
          <div id="floater3" class="floater"></div>
        </div>

        <div class="mt-10 flex flex-col space-y-4 w-full max-w-xs mx-auto">
          <button id="goToSoloBtn"  class="btn cta text-2xl font-bold py-3 px-8">Solo</button>
          <button id="goToMultiBtn" class="btn cta text-2xl font-bold py-3 px-8" disabled style="opacity:.5; cursor:not-allowed">Multijoueur</button>
          <button id="goToRulesBtn" class="btn cta text-xl py-2 px-6">R√®gles</button>
        </div>
      </div>

      <div class="absolute bottom-4 right-4 text-sm opacity-50">Version 2.0 Deluxe</div>
    </div>

    <!-- ===== R√®gles ===== -->
    <div id="rulesScreen" class="screen p-4 text-center">
      <h1 class="text-3xl md:text-4xl my-8">R√®gles du Jeu</h1>
      <div class="text-lg space-y-4 max-w-md" style="background:rgba(255,255,255,.08); padding:16px; border-radius:14px; border:1px solid rgba(255,255,255,.18);">
        <div class="flex items-center"><div id="rules-mole-icon" class="rules-icon" style="width:40px;height:40px;margin-right:15px;"></div><span>Taupe Normale : <span class="text-yellow-300">+1 point</span></span></div>
        <div class="flex items-center"><div id="rules-gold-mole-icon" class="rules-icon" style="width:40px;height:40px;margin-right:15px;"></div><span>Taupe d'Or : <span class="text-yellow-300">+5 points !</span></span></div>
        <div class="flex items-center"><div id="rules-fox-icon" class="rules-icon" style="width:40px;height:40px;margin-right:15px;"></div><span>Renard : <span class="text-red-400">NE PAS TAPER !</span> (-2 pts & -3 sec)</span></div>
      </div>
      <button id="rulesBackBtn" class="btn text-xl font-bold py-2 px-6 rounded-lg mt-8">Retour</button>
    </div>

    <!-- ===== SOLO ===== -->
    <div id="soloHome" class="screen p-4">
      <h1 class="text-4xl md:text-5xl text-center mb-8">Mode Solo</h1>
      <div class="mt-12 flex flex-col space-y-4 w-full max-w-xs">
        <button id="soloPlayBtn" class="btn text-2xl font-bold py-3 px-8 rounded-lg">Jouer</button>
        <button id="soloScoresBtn" class="btn text-2xl font-bold py-3 px-8 rounded-lg">Scores</button>
        <button id="soloRulesBtn" class="btn text-2xl font-bold py-3 px-8 rounded-lg">R√®gles</button>
        <button class="backToMainBtn btn text-xl py-2 px-6 rounded-lg mt-4">Accueil</button>
      </div>
    </div>

    <div id="soloGame" class="screen p-4">
      <div class="text-center mb-4 relative">
        <h1 class="text-3xl md:text-4xl mb-2">Tape-la-taupe !</h1>
        <p class="text-lg">Score: <span id="soloScore" class="text-yellow-300">0</span></p>
        <p class="text-lg mt-2">Temps: <span id="soloTimeLeft" class="text-red-400">30</span></p>
      </div>
      <div id="soloGameBoard" class="game-board" data-tilt="1"></div>
    </div>

    <div id="soloScores" class="screen p-4">
      <h1 class="text-3xl md:text-4xl my-8">Tableau des Scores</h1>
      <ul id="soloScoresList" class="scrollable text-xl space-y-2 text-yellow-300 w-full max-w-md text-center" style="background:rgba(255,255,255,.08); padding:16px; border-radius:14px; border:1px solid rgba(255,255,255,.18);"></ul>
      <button id="soloScoresBackBtn" class="btn text-xl font-bold py-2 px-6 rounded-lg mt-8">Retour</button>
    </div>

    <div id="soloEnd" class="screen p-4 text-center">
      <div class="scrollable w-full max-w-lg">
        <h2 class="text-4xl mb-4 text-yellow-300">Compte-rendu des Taupes</h2>
        <p id="soloFinalScore" class="text-2xl mb-6"></p>
        <div id="soloGeminiLoading" class="hidden text-yellow-300 my-4">Analyse...</div>
        <p id="soloGeminiComment" class="hidden text-md text-yellow-200 italic p-4 rounded-md" style="background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18);"></p>
        <button id="soloDetailsBtn" class="btn text-lg py-2 px-4 rounded-lg mt-4 hidden">D√©tails</button>
        <div id="soloStatsDetails" class="hidden text-lg text-left space-y-2 rounded-md mt-4" style="background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); padding:16px;"></div>
      </div>
      <div id="soloEndButtons" class="mt-8 flex flex-col space-y-4 w-full max-w-xs invisible">
        <button id="soloRestartBtn" class="btn text-2xl font-bold py-3 px-8 rounded-lg">Rejouer</button>
        <button id="soloEndScoresBtn" class="btn text-2xl font-bold py-3 px-8 rounded-lg">Scores</button>
        <button class="backToMainBtn btn text-2xl font-bold py-3 px-8 rounded-lg">Accueil</button>
      </div>
    </div>

    <!-- ===== MULTI (structure) ===== -->
    <div id="multiHome" class="screen p-4 text-center">
      <h1 class="text-4xl md:text-5xl text-center mb-8">Mode Multijoueur</h1>
      <div class="mt-12 flex flex-col space-y-4 w-full max-w-xs">
        <button id="multiCreateBtn" class="btn text-2xl font-bold py-3 px-8 rounded-lg">Cr√©er une Partie</button>
        <button id="multiJoinBtn" class="btn text-2xl font-bold py-3 px-8 rounded-lg">Rejoindre</button>
        <button id="multiRulesBtn" class="btn text-2xl font-bold py-3 px-8 rounded-lg">R√®gles</button>
        <button class="backToMainBtn btn text-xl py-2 px-6 rounded-lg mt-4">Accueil</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ===== Icons ===== */
    const moleSVG = `<svg viewBox="0 0 100 100"><g><circle cx="50" cy="80" r="30" fill="#5D4037"/><ellipse cx="50" cy="70" rx="35" ry="25" fill="#795548"/><circle cx="38" cy="65" r="5" fill="black"/><circle cx="62" cy="65" r="5" fill="black"/><ellipse cx="50" cy="78" rx="8" ry="4" fill="#D32F2F"/></g></svg>`;
    const goldMoleSVG = `<svg viewBox="0 0 100 100"><g><circle cx="50" cy="80" r="30" fill="#FFD700"/><ellipse cx="50" cy="70" rx="35" ry="25" fill="#F9A620"/><circle cx="38" cy="65" r="5" fill="black"/><circle cx="62" cy="65" r="5" fill="black"/><ellipse cx="50" cy="78" rx="8" ry="4" fill="#D32F2F"/></g></svg>`;
    const foxSVG = `<svg viewBox="0 0 100 100"><g><path d="M22 80 C 20 60, 30 50, 50 50 C 70 50, 80 60, 78 80 Z" fill="#E67E22"/><polygon points="40,50 60,50 50,30" fill="white"/><polygon points="20,80 30,75 25,60" fill="white"/><polygon points="80,80 70,75 75,60" fill="white"/><circle cx="40" cy="60" r="4" fill="black"/><circle cx="60" cy="60" r="4" fill="black"/></g></svg>`;

    /* ===== Canvas FX ===== */
    const Visuals = (() => {
      const TAU=Math.PI*2;
      const c=document.getElementById('fx-canvas'), ctx=c.getContext('2d',{alpha:true});
      let W=0,H=0,DPR=Math.min(2, devicePixelRatio||1), parts=[], shakes=0;
      const resize=()=>{ W=c.width=Math.floor(innerWidth*DPR); H=c.height=Math.floor(innerHeight*DPR); c.style.width=innerWidth+'px'; c.style.height=innerHeight+'px'; };
      addEventListener('resize',resize); resize();

      class P{ constructor(x,y,vx,vy,life,size,color,grav=0,fade=true,glow=false){Object.assign(this,{x,y,vx,vy,life,t:0,size,color,grav,fade,glow})}
        step(dt){ this.t+=dt; this.vy+=this.grav*dt; this.x+=this.vx*dt; this.y+=this.vy*dt; return this.t<this.life; }
        draw(){ const k=this.t/this.life,a=this.fade?(1-k):1; ctx.globalAlpha=a; ctx.shadowBlur=this.glow?16*DPR:0; ctx.shadowColor=this.color;
          ctx.beginPath(); ctx.arc(this.x,this.y,this.size*(1+.4*(1-a)),0,TAU); ctx.fillStyle=this.color; ctx.fill(); ctx.globalAlpha=1; ctx.shadowBlur=0; } }

      const ripple=(x,y,color)=>{ const life=.45; const ring=new P(x*DPR,y*DPR,0,0,life,0,color,0,true,false); ring.draw=function(){const k=this.t/this.life; ctx.beginPath(); ctx.arc(this.x,this.y,(30+120*k)*DPR,0,TAU); ctx.strokeStyle=color; ctx.globalAlpha=1-k; ctx.lineWidth=(6-5*k)*DPR; ctx.stroke(); ctx.globalAlpha=1;}; parts.push(ring); };

      const burst=(x,y,kind='good')=>{
        const base = kind==='bad' ? '#ff6b6b' : (kind==='gold' ? '#ffd76d' : '#8ef3ff');
        const n = kind==='bad' ? 14 : 28;
        for(let i=0;i<n;i++){ const a=Math.random()*TAU, s=(kind==='gold'?180:120)+Math.random()*80; parts.push(new P(x*DPR,y*DPR,Math.cos(a)*s,Math.sin(a)*s,.6+.6*Math.random(),3*DPR,base,520,true,true)); }
        ripple(x,y,base); shakes=Math.max(shakes, kind==='bad'?3:2);
      };
      const confetti=()=>{ const cols=['#8ef3ff','#ffb6ff','#ffd76d','#9cff8f']; for(let i=0;i<220;i++){ const x=Math.random()*W, y=-40*DPR*Math.random(), vx=(-50+Math.random()*100), vy=(120+Math.random()*180), c=cols[i%cols.length]; parts.push(new P(x,y,vx,vy,2.6+Math.random(),2.5*DPR,c,420,true,false)); } shakes=Math.max(shakes,6); };

      let last=performance.now();
      const loop=(t)=>{ const dt=Math.min(.033,(t-last)/1000); last=t;
        if(shakes>0){ const a=Math.random()*TAU,m=shakes*DPR; ctx.setTransform(1,0,0,1,Math.cos(a)*m,Math.sin(a)*m); shakes*=.9; if(shakes<.2) shakes=0; } else ctx.setTransform(1,0,0,1,0,0);
        ctx.clearRect(0,0,W,H); parts=parts.filter(p=>{const ok=p.step(dt); if(ok) p.draw(); return ok;}); requestAnimationFrame(loop); };
      requestAnimationFrame(loop);

      return {
        onHit:(x,y,k)=>{ burst(x,y,k); const el=document.elementFromPoint(x,y); if(!el) return; const c=k==='bad'?'hit-bad':'hit-good'; el.classList.add(c); setTimeout(()=>el.classList.remove(c),220); },
        onSpawn:(hole,k)=>{ if(k==='gold'){ hole.style.filter='drop-shadow(0 0 14px rgba(255,215,109,.6))'; setTimeout(()=> hole.style.filter='',260); } },
        onFinale:()=> confetti()
      };
    })();

    /* ===== Audio douce (Tone.js) + HUD ===== */
    const volSlider = document.getElementById('volMusic');
    const muteBtn   = document.getElementById('btnMute');
    const volToDb = v => (v<=0? -Infinity : -48 + v*48);
    let audioStarted=false;

    const softSynth = new Tone.AMSynth({
      harmonicity:1.5,
      envelope:{ attack:0.01, decay:0.6, sustain:0.2, release:1.2 },
      modulationEnvelope:{ attack:0.1, decay:0.4, sustain:0.2, release:1.2 }
    }).toDestination();
    softSynth.volume.value = -14;

    const sounds = {
      mole: new Tone.Synth().toDestination(),
      gold: new Tone.PolySynth(Tone.Synth).toDestination(),
      fox : new Tone.Synth({ oscillator:{ type:'square' }, envelope:{ attack:0.01, decay:0.2, release:0.2 } }).toDestination(),
    };

    // Piste douce : arp√®ges/notes longues
    const homeMusic = new Tone.Sequence((time, note) => {
      softSynth.triggerAttackRelease(note, "1n", time);
    }, [ "C3", ["E3","G3"], "A2", ["D3","F3"], null, ["C3","E3","G3"], "B2", ["D3","G3"] ], "1m");

    const gameMusic = new Tone.Sequence((time, note) => {
      softSynth.triggerAttackRelease(note, "8n", time);
    }, [ "G4","E4","C4","E4","A4","G4","E4", null ], "4n");

    homeMusic.loop = true; gameMusic.loop = true;

    function startAudio(){
      if(audioStarted) return;
      Tone.start().then(()=>{
        Tone.Transport.start();
        audioStarted=true;
        Tone.Destination.volume.value = volToDb(parseFloat(volSlider?.value||'0.35'));
        showScreen('home'); // active la bonne piste
      });
    }

    // HUD
    muteBtn.addEventListener('click', ()=>{
      const muted = muteBtn.getAttribute('aria-pressed')==='true';
      if(muted){
        muteBtn.setAttribute('aria-pressed','false'); muteBtn.textContent='üîà';
        Tone.Destination.mute=false;
        Tone.Destination.volume.value = volToDb(parseFloat(volSlider?.value||'0.35'));
      } else {
        muteBtn.setAttribute('aria-pressed','true'); muteBtn.textContent='üîá';
        Tone.Destination.mute=true;
      }
    });
    volSlider.addEventListener('input',(e)=>{
      if(muteBtn.getAttribute('aria-pressed')==='true') return;
      const v=parseFloat(e.target.value); Tone.Destination.volume.value = volToDb(v);
    });

    /* ===== Navigation & logique d‚Äô√©crans ===== */
    const screens={
      home: document.getElementById('homeScreen'),
      rules: document.getElementById('rulesScreen'),
      soloHome: document.getElementById('soloHome'),
      soloGame: document.getElementById('soloGame'),
      soloScores: document.getElementById('soloScores'),
      soloEnd: document.getElementById('soloEnd'),
      multiHome: document.getElementById('multiHome'),
    };
    function showScreen(id){
      Object.values(screens).forEach(s=>s.classList.remove('active'));
      screens[id]?.classList.add('active');
      if(!audioStarted) return;
      if(id==='home' || id==='soloHome' || id==='multiHome'){
        Tone.Transport.bpm.value = 60; gameMusic.mute = true; homeMusic.mute = false;
      } else if(id==='soloGame'){
        Tone.Transport.bpm.value = 100; homeMusic.mute = true; gameMusic.mute = false;
      } else {
        homeMusic.mute = true; gameMusic.mute = true;
      }
    }

    document.getElementById('goToSoloBtn').addEventListener('click', ()=>{ startAudio(); showScreen('soloHome'); });
    document.getElementById('goToMultiBtn').addEventListener('click', ()=>{ startAudio(); showScreen('multiHome'); });
    document.getElementById('goToRulesBtn').addEventListener('click', ()=>{ previousScreen='home'; showScreen('rules'); });
    document.getElementById('rulesBackBtn').addEventListener('click', ()=> showScreen(previousScreen||'home'));
    document.querySelectorAll('.backToMainBtn').forEach(b=> b.addEventListener('click', ()=> showScreen('home')));

    /* ===== Accueil : d√©cor ===== */
    document.getElementById('floater1').innerHTML = moleSVG;
    document.getElementById('floater2').innerHTML = goldMoleSVG;
    document.getElementById('floater3').innerHTML = foxSVG;

    /* ===== SOLO GAME ===== */
    let previousScreen='soloHome';
    const soloGameManager={
      foxChance:0.30, disappearTime:550, goldMoleChance:0.30,
      score:0, timeLeft:30, timerId:null, loopId:null, creatureTimeouts:new Map(), stats:{},
      elements:{
        score: document.getElementById('soloScore'), timeLeft: document.getElementById('soloTimeLeft'),
        board: document.getElementById('soloGameBoard'), finalScore: document.getElementById('soloFinalScore'),
        geminiLoading: document.getElementById('soloGeminiLoading'), geminiComment: document.getElementById('soloGeminiComment'),
        detailsBtn: document.getElementById('soloDetailsBtn'), statsDetails: document.getElementById('soloStatsDetails'),
        scoresList: document.getElementById('soloScoresList'), endButtons: document.getElementById('soloEndButtons'),
      },
      init(){
        document.getElementById('soloPlayBtn').addEventListener('click', ()=> this.start());
        document.getElementById('soloRulesBtn').addEventListener('click', ()=>{ previousScreen='soloHome'; showScreen('rules'); });
        document.getElementById('soloScoresBtn').addEventListener('click', ()=>{ previousScreen='soloHome'; this.displayScores(); showScreen('soloScores'); });
        document.getElementById('soloScoresBackBtn').addEventListener('click', ()=> showScreen(previousScreen));
        document.getElementById('soloRestartBtn').addEventListener('click', ()=> this.start());
        this.elements.board.addEventListener('mousedown', (e)=> this.whack(e));
        this.elements.detailsBtn.addEventListener('click', ()=> this.elements.statsDetails.classList.toggle('hidden'));
        document.getElementById('soloEndScoresBtn').addEventListener('click', ()=>{ previousScreen='soloEnd'; this.displayScores(); showScreen('soloScores'); });

        // Board parallax
        const board=this.elements.board;
        if(board.dataset.tilt==="1"){
          board.addEventListener('mousemove', (e)=>{
            const r=board.getBoundingClientRect(), x=(e.clientX-r.left)/r.width-.5, y=(e.clientY-r.top)/r.height-.5;
            board.classList.add('tilting');
            board.style.transform=`perspective(1000px) rotateX(${(y*-8)+6}deg) rotateY(${x*8}deg)`;
          });
          board.addEventListener('mouseleave', ()=>{
            board.classList.remove('tilting');
            board.style.transform='perspective(1000px) rotateX(6deg) rotateY(0)';
          });
        }

        this.createBoard();
      },
      createBoard(){
        this.elements.board.innerHTML='';
        for(let i=0;i<9;i++){ const hole=document.createElement('div'); hole.classList.add('hole'); this.elements.board.appendChild(hole); }
      },
      start(){
        this.reset(); showScreen('soloGame');
        this.timerId=setInterval(()=> this.updateTime(),1000); this.loop();
      },
      reset(){
        this.score=0; this.timeLeft=30; this.elements.score.textContent=0; this.elements.timeLeft.textContent=30;
        this.stats={ moles:0, goldMoles:0, foxes:0, totalMoles:0, totalGoldMoles:0, totalFoxes:0, reactionTimes:[], totalClicks:0 };
        clearInterval(this.timerId); clearTimeout(this.loopId); this.creatureTimeouts.forEach(clearTimeout); this.creatureTimeouts.clear();
        this.elements.geminiComment.classList.add('hidden'); this.elements.detailsBtn.classList.add('hidden');
        this.elements.statsDetails.classList.add('hidden'); this.elements.endButtons.classList.add('invisible');
      },
      updateTime(){
        this.timeLeft--; this.elements.timeLeft.textContent=this.timeLeft;
        if(this.timeLeft===10){ Visuals.onFinale(); } // confettis rush final
        if(this.timeLeft<=0) this.end();
      },
      end(){
        clearInterval(this.timerId); clearTimeout(this.loopId); showScreen('soloEnd'); this.saveScore(this.score);
        this.elements.finalScore.textContent=`Score final: ${this.score}`; this.generateReport();
        setTimeout(()=> this.elements.endButtons.classList.remove('invisible'), 3000);
      },
      loop(){
        let speed=Math.max(250, 750 - (this.score*10));
        if(this.timeLeft<=10){ speed/=3; }
        const delay=Math.random()*speed + speed/2;
        this.loopId=setTimeout(()=>{
          const holes=Array.from(this.elements.board.querySelectorAll('.hole:not(.up)'));
          if(holes.length>0) this.popUp(holes[Math.floor(Math.random()*holes.length)]);
          this.loop();
        }, delay);
      },
      popUp(hole){
        let type='mole';
        if(Math.random()<this.foxChance){ type='fox'; this.stats.totalFoxes++; }
        else if(this.timeLeft<20 && Math.random()<this.goldMoleChance){ type='gold_mole'; this.stats.totalGoldMoles++; }
        else { this.stats.totalMoles++; }

        const svg = type==='mole'? moleSVG : (type==='gold_mole'? goldMoleSVG : foxSVG);
        hole.innerHTML = `<div class="creature ${type==='gold_mole'?'gold':''} ${type==='fox'?'fox':''}" data-type="${type}" data-spawn-time="${Date.now()}">${svg}</div>`;
        hole.classList.add('up');

        Visuals.onSpawn(hole, type==='gold_mole' ? 'gold' : (type==='fox' ? 'bad' : 'good'));

        const timeoutId=setTimeout(()=>{ hole.classList.remove('up'); this.creatureTimeouts.delete(hole); }, this.disappearTime);
        this.creatureTimeouts.set(hole, timeoutId);
      },
      whack(e){
        this.stats.totalClicks++;
        const hole=e.target.closest('.hole.up'); if(!hole) return;
        const creature=hole.querySelector('.creature'); const type=creature.dataset.type;
        this.stats.reactionTimes.push(Date.now()-parseInt(creature.dataset.spawnTime));

        Visuals.onHit(e.clientX, e.clientY, type==='fox'?'bad':(type==='gold_mole'?'gold':'good'));

        let text='', color='';
        if(type==='fox'){
          sounds.fox.triggerAttackRelease("C2","8n"); this.stats.foxes++; this.score-=2; this.timeLeft=Math.max(0, this.timeLeft-3);
          text='-2pts'; color='#ef4444'; this.showTimePenalty();
        } else if(type==='gold_mole'){
          sounds.gold.triggerAttackRelease(["C5","E5","G5"],"16n"); this.stats.goldMoles++; this.score+=5; text='+5pts'; color='#FFD700';
        } else {
          sounds.mole.triggerAttackRelease("C4","8n"); this.stats.moles++; this.score++; text='+1pt'; color='white';
        }
        this.showPointPopup(hole,text,color);
        this.elements.score.textContent=this.score; this.elements.timeLeft.textContent=this.timeLeft;
        hole.classList.remove('up'); clearTimeout(this.creatureTimeouts.get(hole)); this.creatureTimeouts.delete(hole);
      },
      showPointPopup(hole, text, color){
        const p=document.createElement('div'); p.textContent=text; p.className='point-popup'; p.style.color=color;
        p.style.left = `${hole.offsetLeft + hole.offsetWidth/2 - 20}px`;
        p.style.top  = `${hole.offsetTop}px`;
        this.elements.board.appendChild(p); setTimeout(()=>p.remove(),1000);
      },
      showTimePenalty(){
        const el=document.createElement('span'); el.textContent='-3s'; el.className='time-penalty-display';
        this.elements.timeLeft.parentElement.appendChild(el); setTimeout(()=> el.remove(),1000);
      },
      saveScore(s){ const scores=JSON.parse(localStorage.getItem('soloScores'))||[]; scores.push(s); localStorage.setItem('soloScores', JSON.stringify(scores)); },
      displayScores(){
        const scores=JSON.parse(localStorage.getItem('soloScores'))||[];
        this.elements.scoresList.innerHTML = scores.length ? scores.map((s,i)=>`<li>Partie ${i+1}: ${s} pts</li>`).join('') : '<li>Aucun score !</li>';
      },
      async generateReport(){
        this.elements.geminiLoading.classList.remove('hidden');
        const totalMolesHit=this.stats.moles+this.stats.goldMoles;
        const clickAcc = this.stats.totalClicks>0 ? `${(totalMolesHit/this.stats.totalClicks*100).toFixed(0)}%` : 'N/A';
        const accMoles = this.stats.totalMoles>0 ? `${(this.stats.moles/this.stats.totalMoles*100).toFixed(0)}%` : 'N/A';
        const accGold  = this.stats.totalGoldMoles>0 ? `${(this.stats.goldMoles/this.stats.totalGoldMoles*100).toFixed(0)}%` : 'N/A';
        const avgReact = this.stats.reactionTimes.length>0 ? (this.stats.reactionTimes.reduce((a,b)=>a+b,0)/this.stats.reactionTimes.length).toFixed(0) : 'N/A';
        this.elements.statsDetails.innerHTML = `
          <p>Pr√©cision (clics): ${clickAcc}</p>
          <p>Taupes: ${this.stats.moles}/${this.stats.totalMoles} (${accMoles})</p>
          <p>Taupes d'or: ${this.stats.goldMoles}/${this.stats.totalGoldMoles} (${accGold})</p>
          <p>Renards touch√©s: ${this.stats.foxes}/${this.stats.totalFoxes}</p>
          <p>Temps de r√©action: ${avgReact}ms</p>`;
        this.elements.geminiLoading.classList.add('hidden');
        this.elements.geminiComment.textContent="Excellent travail ! Continue comme √ßa.";
        this.elements.geminiComment.classList.remove('hidden');
        this.elements.detailsBtn.classList.remove('hidden');
      }
    };

    const multiGameManager={ init(){ document.getElementById('multiRulesBtn').addEventListener('click', ()=>{ previousScreen='multiHome'; showScreen('rules'); }); } };

    // Boot
    function main(){
      soloGameManager.init(); multiGameManager.init();
      document.getElementById('rules-mole-icon').innerHTML = moleSVG;
      document.getElementById('rules-gold-mole-icon').innerHTML = goldMoleSVG;
      document.getElementById('rules-fox-icon').innerHTML = foxSVG;

      // D√©blocage audio au 1er clic
      document.body.addEventListener('click', startAudio, { once:true });
    }
    main();
  </script>
</body>
</html>
